<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <link rel="stylesheet" type="text/css" href="./css/default.css" />
    <link rel="stylesheet" type="text/css" href="./css/code.css" />

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-44373310-1', 'alexbechanko.com');
        ga('send', 'pageview');

    </script>

    <title>Epsilon - Designing Snake in HTML5:Making the Game</title>
</head>
<body>
<header>
    <h1>Epsilon</h1>

    <nav>
        <ul>
            <li><a href="./">Home</a></li>
            <li><a href="./about.html">About</a></li>
            <li><a href="./archive.html">Archive</a></li>
        </ul>
    </nav>
</header>

<article>
<header>
    <h2>
      <a href="design-snake-html5-part3.html">Designing Snake in HTML5:Making the Game</a>
    </h2> 
    Posted on December 13, 2012
</header>

<p>In this post we tie together the structures we designed earlier to the update loop we created in the last post to get a <a href="./games/snake.html">working Snake game.</a></p>
<p>We will also lightly go over the use of keyboard events in this post as well.</p>
<h2 id="organizing-the-game">Organizing the Game</h2>
<p>The way I will be organizing this game is into two separate states, the title screen state and the game screen state. The title screen state simply will show the title of the game, and wait for the player to press the space key. After this, the game will transition into the game screen state, where the actual game is then played.</p>
<h2 id="making-the-title-screen">Making the Title Screen</h2>
<p>So to do this, I need to first make the title screen state.</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee">TitleScreen <span class="kw">=</span>
    title_bitmap<span class="kw">:</span> <span class="ot">undefined</span>
    play_button<span class="kw">:</span>
        pos<span class="kw">:[]</span>
        bitmap<span class="kw">:</span> <span class="ot">undefined</span>

    initialize<span class="kw">:</span> <span class="fu">-&gt;</span>
        <span class="ot">console</span><span class="kw">.</span>log<span class="kw">(</span><span class="st">'init'</span><span class="kw">)</span>

        <span class="co">#the title bitmap</span>
        <span class="dt">this</span><span class="kw">.</span>title_bitmap <span class="kw">=</span> document<span class="kw">.</span>createElement<span class="kw">(</span><span class="st">'canvas'</span><span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>title_bitmap<span class="kw">.</span>width <span class="kw">=</span> Window<span class="kw">.</span>WIDTH
        <span class="dt">this</span><span class="kw">.</span>title_bitmap<span class="kw">.</span>height <span class="kw">=</span> Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">4</span> <span class="kw">+</span> <span class="dv">10</span>
        c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>title_bitmap<span class="kw">.</span>getContext<span class="kw">(</span><span class="st">'2d'</span><span class="kw">)</span>
        c<span class="kw">.</span>textAlign <span class="kw">=</span> <span class="st">&quot;center&quot;</span>
        c<span class="kw">.</span>font <span class="kw">=</span> <span class="kw">(</span>Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">4</span><span class="kw">).</span>toString<span class="kw">()</span> <span class="kw">+</span> <span class="st">&quot;px Sans-Serif&quot;</span>
        c<span class="kw">.</span>fillStyle <span class="kw">=</span> <span class="st">&quot;blue&quot;</span>
        c<span class="kw">.</span>fillText<span class="kw">(</span><span class="st">&quot;Snake&quot;</span><span class="kw">,</span> Window<span class="kw">.</span>WIDTH <span class="st">/ 2,  Window.HEIGHT /</span> <span class="dv">4</span><span class="kw">)</span>

        <span class="co">#play button bitmap</span>
        bitmap <span class="kw">=</span> document<span class="kw">.</span>createElement<span class="kw">(</span><span class="st">'canvas'</span><span class="kw">)</span>
        bitmap<span class="kw">.</span>width <span class="kw">=</span> Window<span class="kw">.</span>WIDTH
        bitmap<span class="kw">.</span>height <span class="kw">=</span> Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">6</span>
        c <span class="kw">=</span> bitmap<span class="kw">.</span>getContext<span class="kw">(</span><span class="st">'2d'</span><span class="kw">)</span>
        c<span class="kw">.</span>textAlign <span class="kw">=</span> <span class="st">'center'</span>
        c<span class="kw">.</span>font <span class="kw">=</span> <span class="kw">(</span>Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">12</span><span class="kw">).</span>toString<span class="kw">()</span> <span class="kw">+</span> <span class="st">&quot;px Sans-Serif&quot;</span>
        c<span class="kw">.</span>fillText<span class="kw">(</span><span class="st">&quot;Press Space To Play&quot;</span><span class="kw">,</span> Window<span class="kw">.</span>WIDTH<span class="st">/2,Window.HEIGHT /</span> <span class="dv">8</span><span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>play_button<span class="kw">.</span>bitmap <span class="kw">=</span> bitmap
        <span class="dt">this</span><span class="kw">.</span>play_button<span class="kw">.</span>pos <span class="kw">=</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">,</span> <span class="dv">2</span> <span class="kw">*</span> Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">4</span><span class="kw">]</span>

    run<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span>
        <span class="dt">this</span><span class="kw">.</span>update<span class="kw">(</span>time_delta<span class="kw">,</span> now<span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>draw<span class="kw">()</span>

    update<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span> <span class="kw">return</span> <span class="ot">null</span>

    draw<span class="kw">:</span> <span class="fu">-&gt;</span>
        clear_context<span class="kw">()</span>
        Window<span class="kw">.</span>context<span class="kw">.</span>drawImage<span class="kw">(</span><span class="dt">this</span><span class="kw">.</span>title_bitmap<span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">)</span>
        c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>play_button<span class="kw">.</span>pos
        Window<span class="kw">.</span>context<span class="kw">.</span>drawImage<span class="kw">(</span><span class="dt">this</span><span class="kw">.</span>play_button<span class="kw">.</span>bitmap<span class="kw">,</span> c<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> c<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">)</span>

    keyboard_callback<span class="kw">:</span> <span class="fu">(event) -&gt;</span>
        <span class="ot">console</span><span class="kw">.</span>log<span class="kw">(</span>event<span class="kw">.</span>keyCode<span class="kw">)</span>
        <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">32</span>
            Window<span class="kw">.</span>screen <span class="kw">=</span> GameScreen</code></pre></div>
<p>This is the basic structure a single state will have in Snake. There will be an object that has an <code>initialize</code>, <code>run</code>, <code>draw</code> and <code>keyboard_callback</code> functions. These functions will do exactly what you may expect them to do based on their names. The <code>initialize</code> function sets up the object to be able to do everything it wants. The <code>run</code> function is what is called by my game every time it wants an update. The <code>update</code> function is the function that updates the in-game objects with the time. The <code>draw</code> function is what actually draws the game objects to the canvas screen. Finally, the <code>keyboard_callback</code> is called for when any keyboard event is registered with the game’s canvas screen.</p>
<p>In the title screen state, there is not much to set up and draw. There’s two text boxes, one that states the title, the other that states how to start the game. Both are set up in the <code>initialize</code> function. Then this state just draws these two text boxes until the game receives an event that says the space bar was pressed.</p>
<h2 id="initializing-the-game">Initializing the Game</h2>
<p>Finally, when that event is registered, we switch to the game screen state. Here is the initialization of the game.</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee">initialize<span class="kw">:</span> <span class="fu">-&gt;</span>
    <span class="co">#init snake entity, include loading of its canvas</span>
    <span class="dt">this</span><span class="kw">.</span>_init_snake<span class="kw">()</span>
    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap <span class="kw">=</span> document<span class="kw">.</span>createElement<span class="kw">(</span><span class="st">'canvas'</span><span class="kw">)</span>
    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap<span class="kw">.</span>width <span class="kw">=</span> Cell<span class="kw">.</span>WIDTH
    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap<span class="kw">.</span>height <span class="kw">=</span> Cell<span class="kw">.</span>HEIGHT
    c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap<span class="kw">.</span>getContext<span class="kw">(</span><span class="st">'2d'</span><span class="kw">)</span>
    draw_cell<span class="kw">([</span><span class="dv">0</span><span class="kw">,</span><span class="dv">0</span><span class="kw">],</span> c<span class="kw">)</span>

    <span class="co">#init food entity, include loading of its canvas</span>
    <span class="dt">this</span><span class="kw">.</span>_init_food<span class="kw">()</span>
    <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap <span class="kw">=</span> document<span class="kw">.</span>createElement<span class="kw">(</span><span class="st">'canvas'</span><span class="kw">)</span>
    <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap<span class="kw">.</span>width <span class="kw">=</span> Cell<span class="kw">.</span>WIDTH
    <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap<span class="kw">.</span>height <span class="kw">=</span> Cell<span class="kw">.</span>HEIGHT
    c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap<span class="kw">.</span>getContext<span class="kw">(</span><span class="st">'2d'</span><span class="kw">)</span>
    draw_cell<span class="kw">([</span><span class="dv">0</span><span class="kw">,</span><span class="dv">0</span><span class="kw">],</span> c<span class="kw">)</span>

    <span class="co">#create the div that holds the score for the game</span>
    Window<span class="kw">.</span>div<span class="kw">.</span>html<span class="kw">(</span><span class="st">'bottom'</span><span class="kw">,</span> <span class="st">&quot;&lt;div id='snake_score'&gt;&lt;/div&gt;&quot;</span><span class="kw">)</span>
    <span class="dt">this</span><span class="kw">.</span>_update_score<span class="kw">()</span></code></pre></div>
<p>This creates the snake object and the food object. It also creates the HTML necessary to keep track of the score. In this <code>initialize</code> method we call two other methods for initializing the snake and the food. Here is the snake initialization</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#initializes/resets the snake entity</span>
_init_snake<span class="kw">:</span> <span class="fu">-&gt;</span>
    <span class="kw">if</span> Window<span class="kw">.</span>COLS <span class="kw">&gt;</span> <span class="dv">5</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells <span class="kw">=</span> <span class="kw">([</span>i<span class="kw">,</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">5</span><span class="kw">..</span><span class="dv">0</span><span class="kw">])</span>
    <span class="kw">else</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells <span class="kw">=</span> <span class="kw">[]</span>


    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>RIGHT
    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>last_move <span class="kw">=</span> <span class="kw">+new</span> <span class="dt">Date</span><span class="kw">()</span>
    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset <span class="kw">=</span> <span class="ot">false</span>
    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten <span class="kw">=</span> <span class="dv">0</span>
    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth <span class="kw">=</span> <span class="dv">0</span></code></pre></div>
<p>So this sets up some default parameters, such as the snake’s length starting direction, last movement time, etc. This is the food set up</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#initializes/resets the food entity</span>
_init_food<span class="kw">:</span> <span class="fu">-&gt;</span>
    <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell <span class="kw">=</span> <span class="kw">[</span>
        <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">(</span><span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span> <span class="kw">*</span> Window<span class="kw">.</span>COLS<span class="kw">),</span>
        <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">(</span><span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span> <span class="kw">*</span> Window<span class="kw">.</span>ROWS<span class="kw">)</span>
    <span class="kw">]</span>
    <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell <span class="kw">in</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells
        <span class="dt">this</span><span class="kw">.</span>_init_food<span class="kw">()</span></code></pre></div>
<p>The food is much easier to set up. The food cell is given a random location, but it checks to make sure that it is not in the snakes body before finishing.</p>
<h2 id="updating-the-game-objects">Updating the Game objects</h2>
<p>Now we move onto the <code>run</code> method, the method that is called in the looping mechanism we made last post.</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#does an update and draw pass for the GameScreen</span>
run<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span>
    <span class="dt">this</span><span class="kw">.</span>update<span class="kw">(</span>time_delta<span class="kw">,</span> now<span class="kw">)</span>
    clear_context<span class="kw">()</span>
    <span class="dt">this</span><span class="kw">.</span>draw<span class="kw">()</span></code></pre></div>
<p>A rather simple looking update. Call the <code>update</code> method, clear the screen, then call the <code>draw</code> method. Let’s look at the <code>update</code> method.</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#updates the entities of the game screen</span>
update<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span>
    <span class="dt">this</span><span class="kw">.</span>_move_snake<span class="kw">(</span>time_delta<span class="kw">,</span> now<span class="kw">)</span>
    <span class="dt">this</span><span class="kw">.</span>_eat_food<span class="kw">()</span></code></pre></div>
<p>Another simple to digest method. Move the snake, and check if it has landed on a food spot. Here’s the move snake method</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#updates movements of the snake</span>
_move_snake<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span>
    <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset
        <span class="dt">this</span><span class="kw">.</span>_reset_entities<span class="kw">()</span>
        <span class="kw">return</span>

    <span class="kw">if</span> <span class="kw">(</span>now <span class="kw">-</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>last_move<span class="kw">)</span> <span class="kw">&lt;</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>move_interval
        <span class="kw">return</span>

    <span class="co">#front = snake.cells[snake.cells.length - 1]</span>
    front <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>head<span class="kw">()</span>

    <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">==</span> Direction<span class="kw">.</span>RIGHT
        front <span class="kw">=</span> <span class="kw">[</span>front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">+</span> <span class="dv">1</span><span class="kw">,</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]]</span>
    <span class="kw">else</span> <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">==</span> Direction<span class="kw">.</span>LEFT
        front <span class="kw">=</span> <span class="kw">[</span>front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">-</span> <span class="dv">1</span><span class="kw">,</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]]</span>
    <span class="kw">else</span> <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">==</span> Direction<span class="kw">.</span>UP
        front <span class="kw">=</span> <span class="kw">[</span>front<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">-</span> <span class="dv">1</span><span class="kw">]</span>
    <span class="kw">else</span> <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">==</span> Direction<span class="kw">.</span>DOWN
        front <span class="kw">=</span> <span class="kw">[</span>front<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">+</span> <span class="dv">1</span><span class="kw">]</span>

    <span class="kw">if</span> <span class="kw">not</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells<span class="kw">.</span>pop<span class="kw">()</span>
    <span class="kw">else</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth <span class="kw">-</span> <span class="dv">1</span>

    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells<span class="kw">.</span>unshift<span class="kw">(</span>front<span class="kw">)</span>
    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>last_move <span class="kw">=</span> now

    <span class="kw">if</span> front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">&gt;=</span> Window<span class="kw">.</span>COLS <span class="kw">or</span> front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">&gt;=</span> Window<span class="kw">.</span>ROWS <span class="kw">or</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">&lt;</span> <span class="dv">0</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset <span class="kw">=</span> <span class="ot">true</span>

    <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset <span class="kw">or</span> <span class="dt">this</span><span class="kw">.</span>_snake_hits_self<span class="kw">()</span></code></pre></div>
<p>Ah, now this is a little more complex. Above we saw that the snake was stored as a list of cells. To move the snake, we merely push a cell onto this list, and remove the last cell from the list. This gives the appearance of movement. There are some exceptions to this. If the snake just ate, then we do not want the snake to remove the last cell, instead we take note that we ate a cell by decrementing the snake growth variable. After all of this, we do some simple collision detection. We check if the snake hit any walls, or if it hit itself. If it did, we want to reset the game next update. Here is the code for checking if the snake hits itself.</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#a check method for the snake hitting its own body</span>
_snake_hits_self<span class="kw">:</span> <span class="fu">-&gt;</span>
    front <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>head<span class="kw">()</span>
    collide_count <span class="kw">=</span> <span class="dv">0</span>
    <span class="kw">for</span> c <span class="kw">in</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells
        <span class="kw">if</span> front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">==</span> c<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">and</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">==</span> c<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span>
            collide_count <span class="kw">=</span> collide_count <span class="kw">+</span> <span class="dv">1</span>
            <span class="kw">if</span> <span class="dv">1</span> <span class="kw">&lt;</span> collide_count <span class="kw">then</span> <span class="kw">return</span> <span class="ot">true</span>
    <span class="kw">return</span> <span class="ot">false</span></code></pre></div>
<p>This method checks to see if the front of the snake appears anywhere else in its body. If it does, then we know the snake has bit itself. After this is done, the game checks to see if the snake ate a food cell</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#an update method for handling when a piece of food is eaten</span>
_eat_food<span class="kw">:</span> <span class="fu">-&gt;</span>
    front <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>head<span class="kw">()</span>
    <span class="kw">if</span> front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">==</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">and</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">==</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten <span class="kw">+</span> <span class="dv">1</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten
        <span class="dt">this</span><span class="kw">.</span>_init_food<span class="kw">()</span>
        <span class="dt">this</span><span class="kw">.</span>_update_score<span class="kw">()</span></code></pre></div>
<p>If the snake did eat some food, reset the food, and update the score to reflect the food eaten. Here’s the update score method</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#updates the score that is displayed.</span>
_update_score<span class="kw">:</span> <span class="fu">-&gt;</span>
    score <span class="kw">=</span> <span class="st">&quot;Score: &quot;</span> <span class="kw">+</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten<span class="kw">.</span>toString<span class="kw">()</span>
    x$<span class="kw">(</span><span class="st">'#snake_score'</span><span class="kw">).</span>html<span class="kw">(</span>score<span class="kw">)</span></code></pre></div>
<p>Nothing too fancy. It grabs the HTML we put in place for the score, and replaces the old score with the new.</p>
<h2 id="moving-the-snake">Moving the Snake</h2>
<p>This wouldn’t be a game if the player couldn’t do anything. So now we look into letting the player move the snake. Earlier we saw that the snake kept track of its position. So, any input the player does will change which the direction the snake goes in. Here is the keyboard callback</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#makes the snake react to certain keypresses to direct it.</span>
keyboard_callback<span class="kw">:</span> <span class="fu">(event) -&gt;</span>
    s <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake
    <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">37</span> <span class="kw">and</span> Direction<span class="kw">.</span>opposite<span class="kw">(</span>s<span class="kw">.</span>direction<span class="kw">)</span> <span class="kw">!=</span> Direction<span class="kw">.</span>LEFT
        s<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>LEFT
    <span class="kw">else</span> <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">38</span> <span class="kw">and</span> Direction<span class="kw">.</span>opposite<span class="kw">(</span>s<span class="kw">.</span>direction<span class="kw">)</span> <span class="kw">!=</span> Direction<span class="kw">.</span>UP
        s<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>UP
    <span class="kw">else</span> <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">39</span> <span class="kw">and</span> Direction<span class="kw">.</span>opposite<span class="kw">(</span>s<span class="kw">.</span>direction<span class="kw">)</span> <span class="kw">!=</span> Direction<span class="kw">.</span>RIGHT
        s<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>RIGHT
    <span class="kw">else</span> <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">40</span> <span class="kw">and</span> Direction<span class="kw">.</span>opposite<span class="kw">(</span>s<span class="kw">.</span>direction<span class="kw">)</span> <span class="kw">!=</span> Direction<span class="kw">.</span>DOWN
        s<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>DOWN</code></pre></div>
<p>This method looks for arrow key presses, and checks to make sure that the snake doesn’t reverse direction. If the direction the player inputs is not the reverse of the snakes current heading, then this replaces the snake heading.</p>
<h2 id="drawing-the-game">Drawing the Game</h2>
<p>Finally, the game draws the snake and the food cell. Here is the code for this.</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">#draws the entities of the game screen</span>
draw<span class="kw">:</span> <span class="fu">-&gt;</span>
    Window<span class="kw">.</span>context<span class="kw">.</span>drawImage<span class="kw">(</span><span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap<span class="kw">,</span> c<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>WIDTH<span class="kw">,</span> c<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>HEIGHT<span class="kw">)</span> <span class="kw">for</span> c <span class="kw">in</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells
    c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell
    Window<span class="kw">.</span>context<span class="kw">.</span>drawImage<span class="kw">(</span><span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap<span class="kw">,</span> c<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>WIDTH<span class="kw">,</span> c<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>HEIGHT<span class="kw">)</span></code></pre></div>
<p>Remember that the <code>Window</code> structure keeps track of the canvas, so we can just blit the snake, and the food onto the screen. And there you have it! A Snake game done in Coffeescript! Here is the complete code for the game, if you want to see the whole picture.</p>
<div class="sourceCode"><pre class="sourceCode coffee"><code class="sourceCode coffee"><span class="co">###</span>
<span class="co">#Sets up the drawing callback to use the requestAnimationFrame if possible</span>
<span class="co">#otherwise falls back on a setTimeout</span>
<span class="co">###</span>
raf <span class="kw">=</span> window<span class="kw">.</span>requestAnimationFrame     <span class="kw">||</span>
    window<span class="kw">.</span>webkitRequestAnimationFrame <span class="kw">||</span>
    window<span class="kw">.</span>mozRequestAnimationFrame    <span class="kw">||</span>
    window<span class="kw">.</span>msRequestAnimationFrame

window<span class="kw">.</span>animLoop <span class="kw">=</span> <span class="fu">(render, element) -&gt;</span>
    running <span class="kw">=</span> <span class="ot">undefined</span>
    last_frame <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span>
    window_loop <span class="kw">=</span> <span class="fu">(now) -&gt;</span>
        <span class="co">#stop rendering if the render function returned false at some point</span>
        <span class="kw">if</span> running <span class="kw">==</span> <span class="ot">false</span>
            <span class="kw">return</span>

        <span class="kw">if</span> raf
            raf<span class="kw">(</span>window_loop<span class="kw">,</span> element<span class="kw">)</span>
        <span class="kw">else</span>
            <span class="ot">setTimeout</span><span class="kw">(</span>window_loop<span class="kw">,</span> <span class="dv">16</span><span class="kw">)</span>

        now <span class="kw">=</span> <span class="kw">if</span> now <span class="kw">and</span> now <span class="kw">&gt;</span> <span class="fl">1e4</span> <span class="kw">then</span> now <span class="kw">else</span> <span class="kw">+new</span> <span class="dt">Date</span>
        deltaT <span class="kw">=</span> now <span class="kw">-</span> last_frame

        <span class="kw">if</span> deltaT <span class="kw">&lt;</span> <span class="dv">160</span>
            running <span class="kw">=</span> render<span class="kw">(</span>deltaT<span class="kw">,</span> now<span class="kw">)</span>
        last_frame <span class="kw">=</span> now
    window_loop<span class="kw">()</span>

<span class="co">#BEGIN GAME CODE###############################################################</span>

<span class="co">#Direction enumeration for possible directions, as well as some nice methods</span>
<span class="co">#for use with directions</span>
Direction <span class="kw">=</span>
    RIGHT <span class="kw">:</span><span class="dv">0</span>
    LEFT  <span class="kw">:</span><span class="dv">1</span>
    UP    <span class="kw">:</span><span class="dv">2</span>
    DOWN  <span class="kw">:</span><span class="dv">3</span>

    opposite <span class="kw">:</span> <span class="fu">(dir) -&gt;</span>
        <span class="kw">if</span> dir <span class="kw">==</span> Direction<span class="kw">.</span>RIGHT
            <span class="kw">return</span> Direction<span class="kw">.</span>LEFT
        <span class="kw">else</span> <span class="kw">if</span> dir <span class="kw">==</span> Direction<span class="kw">.</span>LEFT
            <span class="kw">return</span> Direction<span class="kw">.</span>RIGHT
        <span class="kw">else</span> <span class="kw">if</span> dir <span class="kw">==</span> Direction<span class="kw">.</span>UP
            <span class="kw">return</span> Direction<span class="kw">.</span>DOWN
        <span class="kw">else</span> <span class="kw">if</span> dir <span class="kw">==</span> Direction<span class="kw">.</span>DOWN
            <span class="kw">return</span> Direction<span class="kw">.</span>UP

<span class="co">#Simple enumeration of colors that are used in the game</span>
Color <span class="kw">=</span>
    WHITE<span class="kw">:</span><span class="st">&quot;#ffffff&quot;</span>
    BLACK<span class="kw">:</span><span class="st">&quot;#000000&quot;</span>
    GREEN<span class="kw">:</span><span class="st">&quot;#00ff00&quot;</span>
    BLUE <span class="kw">:</span><span class="st">&quot;#0000ff&quot;</span>
    GRAY<span class="kw">:</span><span class="st">&quot;#dddddd&quot;</span>

<span class="co">#The window object contains the necessary information regarding the main</span>
<span class="co">#canvas size, the number of rows and cols of cells there are,</span>
<span class="co">#as well as the canvas context so that things may be drawn to it.</span>
<span class="co">#There is also a reference to the current state of the game that is used for</span>
<span class="co">#update calls for the game</span>
Window <span class="kw">=</span>
    COLS<span class="kw">:</span>   <span class="dv">40</span>
    ROWS<span class="kw">:</span>   <span class="dv">40</span>
    WIDTH<span class="kw">:</span>  <span class="dv">400</span>
    HEIGHT<span class="kw">:</span> <span class="dv">400</span>
    FPS<span class="kw">:</span>    <span class="dv">60</span>


    div<span class="kw">:{}</span>
    context<span class="kw">:{}</span>
    screen<span class="kw">:{}</span>

<span class="co">#The cell object contains information regarding a cells dimensions</span>
Cell <span class="kw">=</span>
    WIDTH<span class="kw">:</span> <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">(</span>Window<span class="kw">.</span>WIDTH <span class="kw">/</span> Window<span class="kw">.</span>COLS<span class="kw">)</span>
    HEIGHT<span class="kw">:</span> <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">(</span>Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> Window<span class="kw">.</span>ROWS<span class="kw">)</span>

GameScreen <span class="kw">=</span>
    snake<span class="kw">:</span>
        reset<span class="kw">:</span> <span class="ot">false</span>
        cells<span class="kw">:</span> <span class="kw">[]</span>
        direction<span class="kw">:</span> Direction<span class="kw">.</span>RIGHT
        move_interval<span class="kw">:</span> <span class="dv">100</span>
        last_move<span class="kw">:</span> <span class="dv">0</span>
        eaten<span class="kw">:</span> <span class="dv">0</span>
        growth<span class="kw">:</span> <span class="dv">0</span>
        bitmap<span class="kw">:</span> <span class="ot">undefined</span>

        <span class="co">#returns the cell the snake's head is located</span>
        <span class="co">#before this used to vary so this was a necessary abstraction</span>
        head<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">this</span><span class="kw">.</span>cells<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span>

    food <span class="kw">:</span>
        cell<span class="kw">:</span> <span class="kw">[]</span>
        bitmap<span class="kw">:</span> <span class="ot">undefined</span>

    <span class="co">#--PUBLIC METHODS--#</span>
    <span class="co">#loads necessary images for game screen, initializes/resets entities</span>
    initialize<span class="kw">:</span> <span class="fu">-&gt;</span>
        <span class="co">#init snake entity, include loading of its canvas</span>
        <span class="dt">this</span><span class="kw">.</span>_init_snake<span class="kw">()</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap <span class="kw">=</span> document<span class="kw">.</span>createElement<span class="kw">(</span><span class="st">'canvas'</span><span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap<span class="kw">.</span>width <span class="kw">=</span> Cell<span class="kw">.</span>WIDTH
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap<span class="kw">.</span>height <span class="kw">=</span> Cell<span class="kw">.</span>HEIGHT
        c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap<span class="kw">.</span>getContext<span class="kw">(</span><span class="st">'2d'</span><span class="kw">)</span>
        draw_cell<span class="kw">([</span><span class="dv">0</span><span class="kw">,</span><span class="dv">0</span><span class="kw">],</span> c<span class="kw">)</span>

        <span class="co">#init food entity, include loading of its canvas</span>
        <span class="dt">this</span><span class="kw">.</span>_init_food<span class="kw">()</span>
        <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap <span class="kw">=</span> document<span class="kw">.</span>createElement<span class="kw">(</span><span class="st">'canvas'</span><span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap<span class="kw">.</span>width <span class="kw">=</span> Cell<span class="kw">.</span>WIDTH
        <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap<span class="kw">.</span>height <span class="kw">=</span> Cell<span class="kw">.</span>HEIGHT
        c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap<span class="kw">.</span>getContext<span class="kw">(</span><span class="st">'2d'</span><span class="kw">)</span>
        draw_cell<span class="kw">([</span><span class="dv">0</span><span class="kw">,</span><span class="dv">0</span><span class="kw">],</span> c<span class="kw">)</span>

        <span class="co">#create the div that holds the score for the game</span>
        Window<span class="kw">.</span>div<span class="kw">.</span>html<span class="kw">(</span><span class="st">'bottom'</span><span class="kw">,</span> <span class="st">&quot;&lt;div id='snake_score'&gt;&lt;/div&gt;&quot;</span><span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>_update_score<span class="kw">()</span>

    <span class="co">#does an update and draw pass for the GameScreen</span>
    run<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span>
        <span class="dt">this</span><span class="kw">.</span>update<span class="kw">(</span>time_delta<span class="kw">,</span> now<span class="kw">)</span>
        clear_context<span class="kw">()</span>
        <span class="dt">this</span><span class="kw">.</span>draw<span class="kw">()</span>

    <span class="co">#draws the entities of the game screen</span>
    draw<span class="kw">:</span> <span class="fu">-&gt;</span>
        Window<span class="kw">.</span>context<span class="kw">.</span>drawImage<span class="kw">(</span><span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>bitmap<span class="kw">,</span> c<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>WIDTH<span class="kw">,</span> c<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>HEIGHT<span class="kw">)</span> <span class="kw">for</span> c <span class="kw">in</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells
        c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell
        Window<span class="kw">.</span>context<span class="kw">.</span>drawImage<span class="kw">(</span><span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>bitmap<span class="kw">,</span> c<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>WIDTH<span class="kw">,</span> c<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>HEIGHT<span class="kw">)</span>

    <span class="co">#updates the entities of the game screen</span>
    update<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span>
        <span class="dt">this</span><span class="kw">.</span>_move_snake<span class="kw">(</span>time_delta<span class="kw">,</span> now<span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>_eat_food<span class="kw">()</span>

    <span class="co">#makes the snake react to certain keypresses to direct it.</span>
    keyboard_callback<span class="kw">:</span> <span class="fu">(event) -&gt;</span>
        s <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake
        <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">37</span> <span class="kw">and</span> Direction<span class="kw">.</span>opposite<span class="kw">(</span>s<span class="kw">.</span>direction<span class="kw">)</span> <span class="kw">!=</span> Direction<span class="kw">.</span>LEFT
            s<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>LEFT
        <span class="kw">else</span> <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">38</span> <span class="kw">and</span> Direction<span class="kw">.</span>opposite<span class="kw">(</span>s<span class="kw">.</span>direction<span class="kw">)</span> <span class="kw">!=</span> Direction<span class="kw">.</span>UP
            s<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>UP
        <span class="kw">else</span> <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">39</span> <span class="kw">and</span> Direction<span class="kw">.</span>opposite<span class="kw">(</span>s<span class="kw">.</span>direction<span class="kw">)</span> <span class="kw">!=</span> Direction<span class="kw">.</span>RIGHT
            s<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>RIGHT
        <span class="kw">else</span> <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">40</span> <span class="kw">and</span> Direction<span class="kw">.</span>opposite<span class="kw">(</span>s<span class="kw">.</span>direction<span class="kw">)</span> <span class="kw">!=</span> Direction<span class="kw">.</span>DOWN
            s<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>DOWN

    <span class="co">#---PRIVATE METHODS---#</span>
    <span class="co">#initializes/resets the food entity</span>
    _init_food<span class="kw">:</span> <span class="fu">-&gt;</span>
        <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell <span class="kw">=</span> <span class="kw">[</span>
            <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">(</span><span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span> <span class="kw">*</span> Window<span class="kw">.</span>COLS<span class="kw">),</span>
            <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">(</span><span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span> <span class="kw">*</span> Window<span class="kw">.</span>ROWS<span class="kw">)</span>
        <span class="kw">]</span>
        <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell <span class="kw">in</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells
            <span class="dt">this</span><span class="kw">.</span>_init_food<span class="kw">()</span>

    <span class="co">#initializes/resets the snake entity</span>
    _init_snake<span class="kw">:</span> <span class="fu">-&gt;</span>
        <span class="kw">if</span> Window<span class="kw">.</span>COLS <span class="kw">&gt;</span> <span class="dv">5</span>
            <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells <span class="kw">=</span> <span class="kw">([</span>i<span class="kw">,</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">5</span><span class="kw">..</span><span class="dv">0</span><span class="kw">])</span>
        <span class="kw">else</span>
            <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells <span class="kw">=</span> <span class="kw">[]</span>


        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">=</span> Direction<span class="kw">.</span>RIGHT
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>last_move <span class="kw">=</span> <span class="kw">+new</span> <span class="dt">Date</span><span class="kw">()</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset <span class="kw">=</span> <span class="ot">false</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten <span class="kw">=</span> <span class="dv">0</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth <span class="kw">=</span> <span class="dv">0</span>

    <span class="co">#updates the score that is displayed.</span>
    _update_score<span class="kw">:</span> <span class="fu">-&gt;</span>
        score <span class="kw">=</span> <span class="st">&quot;Score: &quot;</span> <span class="kw">+</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten<span class="kw">.</span>toString<span class="kw">()</span>
        x$<span class="kw">(</span><span class="st">'#snake_score'</span><span class="kw">).</span>html<span class="kw">(</span>score<span class="kw">)</span>

    <span class="co">#updates movements of the snake</span>
    _move_snake<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span>
        <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset
            <span class="dt">this</span><span class="kw">.</span>_reset_entities<span class="kw">()</span>
            <span class="kw">return</span>

        <span class="kw">if</span> <span class="kw">(</span>now <span class="kw">-</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>last_move<span class="kw">)</span> <span class="kw">&lt;</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>move_interval
            <span class="kw">return</span>

        <span class="co">#front = snake.cells[snake.cells.length - 1]</span>
        front <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>head<span class="kw">()</span>

        <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">==</span> Direction<span class="kw">.</span>RIGHT
            front <span class="kw">=</span> <span class="kw">[</span>front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">+</span> <span class="dv">1</span><span class="kw">,</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]]</span>
        <span class="kw">else</span> <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">==</span> Direction<span class="kw">.</span>LEFT
            front <span class="kw">=</span> <span class="kw">[</span>front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">-</span> <span class="dv">1</span><span class="kw">,</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]]</span>
        <span class="kw">else</span> <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">==</span> Direction<span class="kw">.</span>UP
            front <span class="kw">=</span> <span class="kw">[</span>front<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">-</span> <span class="dv">1</span><span class="kw">]</span>
        <span class="kw">else</span> <span class="kw">if</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>direction <span class="kw">==</span> Direction<span class="kw">.</span>DOWN
            front <span class="kw">=</span> <span class="kw">[</span>front<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">+</span> <span class="dv">1</span><span class="kw">]</span>

        <span class="kw">if</span> <span class="kw">not</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth
            <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells<span class="kw">.</span>pop<span class="kw">()</span>
        <span class="kw">else</span>
            <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth <span class="kw">-</span> <span class="dv">1</span>

        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells<span class="kw">.</span>unshift<span class="kw">(</span>front<span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>last_move <span class="kw">=</span> now

        <span class="kw">if</span> front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">&gt;=</span> Window<span class="kw">.</span>COLS <span class="kw">or</span> front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">&gt;=</span> Window<span class="kw">.</span>ROWS <span class="kw">or</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">&lt;</span> <span class="dv">0</span>
            <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset <span class="kw">=</span> <span class="ot">true</span>

        <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>reset <span class="kw">or</span> <span class="dt">this</span><span class="kw">.</span>_snake_hits_self<span class="kw">()</span>

    <span class="co">#a check method for the snake hitting its own body</span>
    _snake_hits_self<span class="kw">:</span> <span class="fu">-&gt;</span>
        front <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>head<span class="kw">()</span>
        collide_count <span class="kw">=</span> <span class="dv">0</span>
        <span class="kw">for</span> c <span class="kw">in</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>cells
            <span class="kw">if</span> front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">==</span> c<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">and</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">==</span> c<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span>
                collide_count <span class="kw">=</span> collide_count <span class="kw">+</span> <span class="dv">1</span>
                <span class="kw">if</span> <span class="dv">1</span> <span class="kw">&lt;</span> collide_count <span class="kw">then</span> <span class="kw">return</span> <span class="ot">true</span>
        <span class="kw">return</span> <span class="ot">false</span>

    <span class="co">#reset method for starting a game over</span>
    _reset_entities<span class="kw">:</span> <span class="fu">-&gt;</span>
        <span class="dt">this</span><span class="kw">.</span>_init_snake<span class="kw">()</span>
        <span class="dt">this</span><span class="kw">.</span>_init_food<span class="kw">()</span>
        <span class="dt">this</span><span class="kw">.</span>_update_score<span class="kw">()</span>

    <span class="co">#an update method for handling when a piece of food is eaten</span>
    _eat_food<span class="kw">:</span> <span class="fu">-&gt;</span>
        front <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>head<span class="kw">()</span>
        <span class="kw">if</span> front<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">==</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">and</span> front<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">==</span> <span class="dt">this</span><span class="kw">.</span>food<span class="kw">.</span>cell<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span>
            <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten <span class="kw">+</span> <span class="dv">1</span>
            <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>growth <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>snake<span class="kw">.</span>eaten
            <span class="dt">this</span><span class="kw">.</span>_init_food<span class="kw">()</span>
            <span class="dt">this</span><span class="kw">.</span>_update_score<span class="kw">()</span>

TitleScreen <span class="kw">=</span>
    title_bitmap<span class="kw">:</span> <span class="ot">undefined</span>
    play_button<span class="kw">:</span>
        pos<span class="kw">:[]</span>
        bitmap<span class="kw">:</span> <span class="ot">undefined</span>

    initialize<span class="kw">:</span> <span class="fu">-&gt;</span>
        <span class="ot">console</span><span class="kw">.</span>log<span class="kw">(</span><span class="st">'init'</span><span class="kw">)</span>

        <span class="co">#the title bitmap</span>
        <span class="dt">this</span><span class="kw">.</span>title_bitmap <span class="kw">=</span> document<span class="kw">.</span>createElement<span class="kw">(</span><span class="st">'canvas'</span><span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>title_bitmap<span class="kw">.</span>width <span class="kw">=</span> Window<span class="kw">.</span>WIDTH
        <span class="dt">this</span><span class="kw">.</span>title_bitmap<span class="kw">.</span>height <span class="kw">=</span> Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">4</span> <span class="kw">+</span> <span class="dv">10</span>
        c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>title_bitmap<span class="kw">.</span>getContext<span class="kw">(</span><span class="st">'2d'</span><span class="kw">)</span>
        c<span class="kw">.</span>textAlign <span class="kw">=</span> <span class="st">&quot;center&quot;</span>
        c<span class="kw">.</span>font <span class="kw">=</span> <span class="kw">(</span>Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">4</span><span class="kw">).</span>toString<span class="kw">()</span> <span class="kw">+</span> <span class="st">&quot;px Sans-Serif&quot;</span>
        c<span class="kw">.</span>fillStyle <span class="kw">=</span> <span class="st">&quot;blue&quot;</span>
        c<span class="kw">.</span>fillText<span class="kw">(</span><span class="st">&quot;Snake&quot;</span><span class="kw">,</span> Window<span class="kw">.</span>WIDTH <span class="st">/ 2,  Window.HEIGHT /</span> <span class="dv">4</span><span class="kw">)</span>

        <span class="co">#play button bitmap</span>
        bitmap <span class="kw">=</span> document<span class="kw">.</span>createElement<span class="kw">(</span><span class="st">'canvas'</span><span class="kw">)</span>
        bitmap<span class="kw">.</span>width <span class="kw">=</span> Window<span class="kw">.</span>WIDTH
        bitmap<span class="kw">.</span>height <span class="kw">=</span> Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">6</span>
        c <span class="kw">=</span> bitmap<span class="kw">.</span>getContext<span class="kw">(</span><span class="st">'2d'</span><span class="kw">)</span>
        c<span class="kw">.</span>textAlign <span class="kw">=</span> <span class="st">'center'</span>
        c<span class="kw">.</span>font <span class="kw">=</span> <span class="kw">(</span>Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">12</span><span class="kw">).</span>toString<span class="kw">()</span> <span class="kw">+</span> <span class="st">&quot;px Sans-Serif&quot;</span>
        c<span class="kw">.</span>fillText<span class="kw">(</span><span class="st">&quot;Press Space To Play&quot;</span><span class="kw">,</span> Window<span class="kw">.</span>WIDTH<span class="st">/2,Window.HEIGHT /</span> <span class="dv">8</span><span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>play_button<span class="kw">.</span>bitmap <span class="kw">=</span> bitmap
        <span class="dt">this</span><span class="kw">.</span>play_button<span class="kw">.</span>pos <span class="kw">=</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">,</span> <span class="dv">2</span> <span class="kw">*</span> Window<span class="kw">.</span>HEIGHT <span class="kw">/</span> <span class="dv">4</span><span class="kw">]</span>

    run<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span>
        <span class="dt">this</span><span class="kw">.</span>update<span class="kw">(</span>time_delta<span class="kw">,</span> now<span class="kw">)</span>
        <span class="dt">this</span><span class="kw">.</span>draw<span class="kw">()</span>

    update<span class="kw">:</span> <span class="fu">(time_delta, now) -&gt;</span> <span class="kw">return</span> <span class="ot">null</span>

    draw<span class="kw">:</span> <span class="fu">-&gt;</span>
        clear_context<span class="kw">()</span>
        Window<span class="kw">.</span>context<span class="kw">.</span>drawImage<span class="kw">(</span><span class="dt">this</span><span class="kw">.</span>title_bitmap<span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">)</span>
        c <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>play_button<span class="kw">.</span>pos
        Window<span class="kw">.</span>context<span class="kw">.</span>drawImage<span class="kw">(</span><span class="dt">this</span><span class="kw">.</span>play_button<span class="kw">.</span>bitmap<span class="kw">,</span> c<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> c<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">)</span>

    keyboard_callback<span class="kw">:</span> <span class="fu">(event) -&gt;</span>
        <span class="ot">console</span><span class="kw">.</span>log<span class="kw">(</span>event<span class="kw">.</span>keyCode<span class="kw">)</span>
        <span class="kw">if</span> event<span class="kw">.</span>keyCode <span class="kw">==</span> <span class="dv">32</span>
            Window<span class="kw">.</span>screen <span class="kw">=</span> GameScreen

draw_cell <span class="kw">=</span>  <span class="fu">(cell, context) -&gt;</span>
    context<span class="kw">.</span>fillStyle <span class="kw">=</span> Color<span class="kw">.</span>WHITE
    context<span class="kw">.</span>strokeStyle <span class="kw">=</span> Color<span class="kw">.</span>BLUE
    context<span class="kw">.</span>fillRect<span class="kw">(</span>
        cell<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>WIDTH
        cell<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>HEIGHT
        Cell<span class="kw">.</span>WIDTH<span class="kw">,</span>
        Cell<span class="kw">.</span>HEIGHT
    <span class="kw">)</span>
    context<span class="kw">.</span>strokeRect<span class="kw">(</span>
        cell<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>WIDTH
        cell<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span> <span class="kw">*</span> Cell<span class="kw">.</span>HEIGHT
        Cell<span class="kw">.</span>WIDTH<span class="kw">,</span>
        Cell<span class="kw">.</span>HEIGHT
    <span class="kw">)</span>

clear_context <span class="kw">=</span> <span class="fu">() -&gt;</span>
    Window<span class="kw">.</span>context<span class="kw">.</span>fillStyle <span class="kw">=</span> Color<span class="kw">.</span>WHITE
    Window<span class="kw">.</span>context<span class="kw">.</span>strokeStyle <span class="kw">=</span> Color<span class="kw">.</span>BLACK

    <span class="co">#background for the snake window</span>
    Window<span class="kw">.</span>context<span class="kw">.</span>fillRect<span class="kw">(</span><span class="dv">0</span><span class="kw">,</span><span class="dv">0</span><span class="kw">,</span>Window<span class="kw">.</span>WIDTH<span class="kw">,</span>Window<span class="kw">.</span>HEIGHT<span class="kw">)</span>
    Window<span class="kw">.</span>context<span class="kw">.</span>strokeRect<span class="kw">(</span><span class="dv">0</span><span class="kw">,</span><span class="dv">0</span><span class="kw">,</span>Window<span class="kw">.</span>WIDTH<span class="kw">,</span>Window<span class="kw">.</span>HEIGHT<span class="kw">)</span>

keyboard_callback <span class="kw">=</span> <span class="fu">(event) -&gt;</span>
    event<span class="kw">.</span>preventDefault<span class="kw">()</span>
    <span class="kw">if</span> Window<span class="kw">.</span>screen<span class="kw">.</span>keyboard_callback<span class="kw">?</span>
        Window<span class="kw">.</span>screen<span class="kw">.</span>keyboard_callback<span class="kw">(</span>event<span class="kw">)</span>

run <span class="kw">=</span> <span class="fu">(time_delta, now) -&gt;</span>
    Window<span class="kw">.</span>screen<span class="kw">.</span>run<span class="kw">(</span>time_delta<span class="kw">,</span> now<span class="kw">)</span>


<span class="co">#returns an object containing necessary snake functionality</span>
<span class="co">#also ties event listeners to the canvas, and adds a interval</span>
<span class="co">#function for drawing</span>
initialize <span class="kw">=</span> <span class="fu">(div_selector) -&gt;</span>
    <span class="co">#initialize the div to be a certain size, and make it contain a canvas element</span>
    div <span class="kw">=</span> x$<span class="kw">(</span>div_selector<span class="kw">)</span>
    div<span class="kw">.</span>css<span class="kw">({</span>border<span class="kw">:</span><span class="st">'2px solid black'</span><span class="kw">,</span> width<span class="kw">:</span>Window<span class="kw">.</span>WIDTH<span class="kw">.</span>toString<span class="kw">()</span> <span class="kw">+</span> <span class="st">&quot;px&quot;</span><span class="kw">})</span>

    canvas_stuff <span class="kw">=</span> <span class="st">&quot;&lt;canvas id='snake_canvas' tabindex='1'&gt;&lt;/canvas&gt;&quot;</span>
    div<span class="kw">.</span>html<span class="kw">(</span>canvas_stuff<span class="kw">)</span>

    canvas <span class="kw">=</span> x$<span class="kw">(</span><span class="st">&quot;#snake_canvas&quot;</span><span class="kw">).</span>attr<span class="kw">(</span><span class="st">'width'</span><span class="kw">,</span> Window<span class="kw">.</span>WIDTH<span class="kw">).</span>attr<span class="kw">(</span><span class="st">'height'</span><span class="kw">,</span> Window<span class="kw">.</span>HEIGHT<span class="kw">)</span>
    x$<span class="kw">(</span>document<span class="kw">).</span><span class="ot">on</span><span class="kw">(</span><span class="st">'keydown'</span><span class="kw">,</span> keyboard_callback<span class="kw">)</span>

    <span class="co">#tie the context to the game</span>
    context <span class="kw">=</span> canvas<span class="kw">.</span>first<span class="kw">().</span>getContext<span class="kw">(</span><span class="st">&quot;2d&quot;</span><span class="kw">)</span>
    canvas<span class="kw">.</span>first<span class="kw">().</span>focus<span class="kw">()</span>
    Window<span class="kw">.</span>context <span class="kw">=</span> context
    Window<span class="kw">.</span>div <span class="kw">=</span> div

    TitleScreen<span class="kw">.</span>initialize<span class="kw">()</span>
    GameScreen<span class="kw">.</span>initialize<span class="kw">()</span>
    <span class="co">#Window.screen = GameScreen</span>
    Window<span class="kw">.</span>screen <span class="kw">=</span> TitleScreen
    window<span class="kw">.</span>animLoop<span class="kw">(</span>run<span class="kw">)</span>


x$<span class="kw">.</span>ready<span class="kw">(</span><span class="fu">() -&gt;</span> initialize<span class="kw">(</span><span class="st">&quot;#snake&quot;</span><span class="kw">))</span></code></pre></div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'chanko08'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>


<footer>
    <div>
        Copyright © 2014 by <a href="./">Epsilon</a>
    </div>

    <div> 
        Powered by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
    </div>

</footer>
</div>
</body>
</html>
